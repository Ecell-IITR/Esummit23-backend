version: "3"
services:
  esummit-backend:
    build:
      context: ./codebase/esummit-backend
      dockerfile: Dockerfile
    working_dir: /usr/esummit-backend
    volumes:
      - ./codebase/esummit-backend:/usr/esummit-backend
    expose:
      - 8000
  esummit-frontend:
    build:
      context: ./codebase/esummit-frontend
      dockerfile: Dockerfile
    working_dir: /usr/esummit-frontend
    volumes:
      - ./codebase/esummit-frontend:/usr/esummit-frontend
      - static-ui-content:/usr/esummit-frontend/build
  esummit23-backend:
    build:
      context: ./codebase/Esummit23-backend
      dockerfile: Dockerfile
    working_dir: /usr/esummit23-backend
    volumes:
      - ./codebase/esummit-backend:/usr/esummit23-backend
    expose:
      - 8000
  esummit22-frontend:
    build:
      context: ./codebase/Esummit22-frontend
      dockerfile: Dockerfile
    working_dir: /usr/esummit22-frontend
    volumes:
      - ./codebase/Esummit22-frontend:/usr/usr/esummit22-frontend
    expose:
      - 3000
  nginx:
    image: nginx:latest
    restart: always
    ports:
      - 82:80
    volumes:
      - ./nginx/nginx-proxy.conf:/etc/nginx/conf.d/default.conf:ro
      # - static-ui-content:/usr/E-cell-Website/frontend/build
      - static-ui-content:/usr/esummit-frontend/build
    depends_on:
      # - ecellbackend
      # - ecellfrontend
      - esummit23-backend
      - esummit-backend
      - esummit-frontend
      - esummit22-frontend
    command: nginx -g 'daemon off';
volumes:
  # static-ui-content:
  static-ui-content:





Dockerfile


FROM python:3.8-alpine

#WORKDIR /usr/Esummit23-backend

ENV PYTHONBUFFERED 1

# install psycopg2 dependencies for postgres
RUN apk update \
  && apk add postgresql-dev gcc python3-dev musl-dev build-base py-pip jpeg-dev zlib-dev wkhtmltopdf xvfb fontconfig ttf-freefont ttf-ubuntu-font-family ffmpeg libwebp libwebp-tools libwebp-dev

RUN pip install --upgrade pip \
  && pip install --upgrade setuptools \
  && pip install --upgrade pipenv  \
  && pip install --upgrade boto3 \
  && pip install --upgrade django-storages
#  && pip install psycopg2

COPY ./requirements.txt /requirements.txt
RUN pip install -r /requirements.txt

RUN mkdir /usr/esummit23-backend
WORKDIR /usr/esummit23-backend

COPY . .

CMD ["sh", "-c", "python manage.py collectstatic --no-input; python manage.py migrate; python manage.py createsuperuser ;gunicorn esummit.wsgi:application -b 0.0.0.0:8000"]


nginx


upstream esummit-django{
    server esummit-backend:8000;
}

upstream esummit23-django{
    server esummit23-backend:9000;
}

upstream esummit22-frontend{
    server esummit22-frontend:3000;
}

server {
    listen 80;
    server_name new.esummit.in;
    charset utf-8;
    client_max_body_size 20M;

    location / {
      root /usr/esummit-frontend/build;
      index index.html index.htm;
      try_files $uri $uri/ /index.html;
    }

#    location ~ ^/(statics|api){
        # Set additional headers in communicating with the application server
#        proxy_set_header    Host              $host;
#       proxy_set_header    X-Real-IP         $remote_addr;
#      proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
#        proxy_set_header    X-Forwarded-Proto $scheme;
#        proxy_pass http://esummit-django;
#    }

#    location ~ /admin/ {
#        # Set additional headers in communicating with the application server
#        proxy_set_header    Host              $host;
#        proxy_set_header    X-Real-IP         $remote_addr;
#        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
#        proxy_set_header    X-Forwarded-Proto $scheme;
#        proxy_pass http://esummit-django;
#    }
#    location ~ /media_files/ {
    # Set additional headers in communicating with the application server
#        proxy_set_header    Host              $host;
#        proxy_set_header    X-Real-IP         $remote_addr;
#        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
#        proxy_set_header    X-Forwarded-Proto $scheme;
#        proxy_pass http://esummit-django;
#       }
}
server {
    listen 80;

    server_name api.esummit.in;
    charset utf-8;
    client_max_body_size 20M;


    location ~ /{
        # Set additional headers in communicating with the application server
        proxy_set_header    Host              $host;
        proxy_set_header    X-Real-IP         $remote_addr;
        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto $scheme;

        proxy_pass http://esummit-django;
    }

    location ~ /admin/ {
        # Set additional headers in communicating with the application server
        proxy_set_header    Host              $host;
        proxy_set_header    X-Real-IP         $remote_addr;
        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto $scheme;

        proxy_pass http://esummit-django;
    }

    location ~ /media_files/ {
        # Set additional headers in communicating with the application server
        proxy_set_header    Host              $host;
        proxy_set_header    X-Real-IP         $remote_addr;
        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto $scheme;

        proxy_pass http://esummit-django;
    }

}

server {
    listen 80;

    server_name newapi.esummit.in;
    charset utf-8;
    client_max_body_size 20M;


    location ~ /{
        # Set additional headers in communicating with the application server
        proxy_set_header    Host              $host;
        proxy_set_header    X-Real-IP         $remote_addr;
        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto $scheme;

        proxy_pass http://esummit23-django;
    }

    location ~ /admin/ {
        # Set additional headers in communicating with the application server
        proxy_set_header    Host              $host;
        proxy_set_header    X-Real-IP         $remote_addr;
        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto $scheme;

        proxy_pass http://esummit23-django;
    }

    location ~ /media_files/ {
        # Set additional headers in communicating with the application server
        proxy_set_header    Host              $host;
        proxy_set_header    X-Real-IP         $remote_addr;
        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto $scheme;

        proxy_pass http://esummit23-django;
    }

}


server {
    listen 80;

    server_name esummit.in www.esummit.in;
    charset utf-8;
    client_max_body_size 20M;


    location ~ /{
        # Set additional headers in communicating with the application server
        proxy_set_header    Host              $host;
        proxy_set_header    X-Real-IP         $remote_addr;
        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto $scheme;

        proxy_pass http://esummit22-frontend;
    }

}





}}


upstream esummit-django{
    server esummit-backend:8000;
}

upstream esummit23-django{
    server esummit23-backend:9000;
}

upstream esummit22-frontend{
    server esummit22-frontend:3000;
}

server {
    listen 80;
    server_name esummit.in www.esummit.in;
    charset utf-8;
    client_max_body_size 20M;

    location / {
      root /usr/esummit-frontend/build;
      index index.html index.htm;
      try_files $uri $uri/ /index.html;
    }

#    location ~ ^/(statics|api){
        # Set additional headers in communicating with the application server
#        proxy_set_header    Host              $host;
#       proxy_set_header    X-Real-IP         $remote_addr;
#      proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
#        proxy_set_header    X-Forwarded-Proto $scheme;
#        proxy_pass http://esummit-django;
#    }

#    location ~ /admin/ {
#        # Set additional headers in communicating with the application server
#        proxy_set_header    Host              $host;
#        proxy_set_header    X-Real-IP         $remote_addr;
#        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
#        proxy_set_header    X-Forwarded-Proto $scheme;
#        proxy_pass http://esummit-django;
#    }
#    location ~ /media_files/ {
    # Set additional headers in communicating with the application server
#        proxy_set_header    Host              $host;
#        proxy_set_header    X-Real-IP         $remote_addr;
#        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
#        proxy_set_header    X-Forwarded-Proto $scheme;
#        proxy_pass http://esummit-django;
#       }
}
server {
    listen 80;

    server_name api.esummit.in;
    charset utf-8;
    client_max_body_size 20M;


    location ~ /{
        # Set additional headers in communicating with the application server
        proxy_set_header    Host              $host;
        proxy_set_header    X-Real-IP         $remote_addr;
        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto $scheme;

        proxy_pass http://esummit-django;
    }

    location ~ /admin/ {
        # Set additional headers in communicating with the application server
        proxy_set_header    Host              $host;
        proxy_set_header    X-Real-IP         $remote_addr;
        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto $scheme;

        proxy_pass http://esummit-django;
    }

    location ~ /media_files/ {
        # Set additional headers in communicating with the application server
        proxy_set_header    Host              $host;
        proxy_set_header    X-Real-IP         $remote_addr;
        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto $scheme;

        proxy_pass http://esummit-django;
    }

}

server {
    listen 80;

    server_name newapi.esummit.in;
    charset utf-8;
    client_max_body_size 20M;


    location ~ /{
        # Set additional headers in communicating with the application server
        proxy_set_header    Host              $host;
        proxy_set_header    X-Real-IP         $remote_addr;
        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto $scheme;

        proxy_pass http://esummit23-django;
    }

    location ~ /admin/ {
        # Set additional headers in communicating with the application server
        proxy_set_header    Host              $host;
        proxy_set_header    X-Real-IP         $remote_addr;
        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto $scheme;

        proxy_pass http://esummit23-django;
    }

    location ~ /media_files/ {
        # Set additional headers in communicating with the application server
        proxy_set_header    Host              $host;
        proxy_set_header    X-Real-IP         $remote_addr;
        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto $scheme;

        proxy_pass http://esummit23-django;
    }

}

server {
    listen 80;

    server_name new.esummit.in;
    charset utf-8;
    client_max_body_size 20M;


    location ~ /{
        # Set additional headers in communicating with the application server
        proxy_set_header    Host              $host;
        proxy_set_header    X-Real-IP         $remote_addr;
        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto $scheme;

        proxy_pass http://esummit22-frontend;
    }



start worker script

until cd /usr/esummit23-backend
do
    echo "Waiting for server volume..."
done

# run a worker :)
celery -A esummit worker -l info -P gevent


start server script

until cd /usr/esummit23-backend
do
    echo "Waiting for server volume..."
done

until python manage.py migrate
do
    echo "Waiting for db to be ready..."
    sleep 2
done


python manage.py collectstatic --noinput


gunicorn esummit.wsgi:application -b 0.0.0.0:9000

worker-entrypoint.sh


RUN chmod +x /usr/esummit23-backend/server-entrypoint.sh
RUN chmod +x /usr/esummit23-backend/worker-entrypoint.sh



FROM python:3.8-alpine

WORKDIR /usr/Esummit23-backend

ENV PYTHONBUFFERED 1


RUN pip install --upgrade pip \
  && pip install --upgrade setuptools \
  && pip install --upgrade pipenv  \
  && pip install --upgrade boto3 \
  && pip install --upgrade django-storages


COPY ./requirements.txt /requirements.txt
RUN pip install -r /requirements.txt


COPY . .


RUN pip install -r requirements.txt



worker:
  restart: always
  build:
    context: ./codebase/Esummit23-backend
    dockerfile: ./codebase/Esummit23-backend/worker/Dockerfile
  command: ./codebase/Esummit23-backend/celery-entrypoint.sh
  links:
    - redis

